<mat-card class="welcome-card">
  <h1>Mis&nbsp;Reservas</h1>
</mat-card>

<div class="container-mis-reservas">
  <!-- ───────── Buscador pill ───────── -->
  <div class="search-bar">
    <div class="search-input-wrap">
      <mat-icon class="search-left">search</mat-icon>
      <input
        class="search-input"
        type="text"
        placeholder="Buscar por código"
        [(ngModel)]="searchTerm"
        (keyup.enter)="search()"
      />
    </div>
    <button class="search-btn" (click)="search()" aria-label="Buscar">
      <mat-icon>search</mat-icon>
    </button>
    
  </div>

  <!-- ───────── Tarjetas de reserva ───────── -->
  <ng-container *ngIf="hasReservas; else noData">

  <div class="carousel-wrapper">
    <!-- flechas -->
    <button class="nav-arrow left" (click)="prevReserva()" aria-label="Anterior">
      <mat-icon>arrow_back_ios_new</mat-icon>
    </button>
    <button class="nav-arrow right" (click)="nextReserva()" aria-label="Siguiente">
      <mat-icon>arrow_forward_ios</mat-icon>
    </button>

    <!-- indicador -->
    <div class="pager">{{ currentIndex + 1 }} / {{ reservas.length }}</div>

    <!-- tarjeta actual -->
    <ng-container *ngIf="current as reserva">
      <div class="reserva-card">

        <!-- Cabecera: sólo “Reserva” -->
        <div class="res-header">
          <div class="res-title">
            <mat-icon>restaurant</mat-icon>
            <span><strong>Reserva:</strong> {{ reserva.idreserva }}</span>
          </div>
        </div>

        <!-- Meta (2 líneas): Fecha y luego Dirección + Estado a la derecha -->
        <div class="res-meta">
          <!-- línea 1: fecha -->
          <div class="meta-row">
            <div class="meta-item">
              <mat-icon>event</mat-icon>
              <span class="meta-text"><strong>Fecha:</strong> {{ reserva.fechaevento }}</span>
            </div>
          </div>

          <!-- línea 2: dirección (izq) + estado (der) -->
          <div class="meta-row with-status">
            <div class="meta-item">
              <mat-icon>place</mat-icon>
              <span class="meta-text"><strong>Dirección:</strong> {{ reserva.direccionevento }}</span>
            </div>

            <span class="status-pill"
                  [ngClass]="(reserva?.nombre?.estado_reserva || '').toLowerCase()">
              {{ reserva?.nombre?.estado_reserva }}
            </span>
          </div>
        </div>

        <!-- Tabla -->
        <div class="table-wrapper">
          <table class="tabla">
            <thead>
              <tr>
                <th>Menú</th>
                <th>Precio Unitario</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let det of reserva.detalles">
                <td>{{ det.menu?.nombre }}</td>
                <td>${{ det.preciounitario }}</td>
                <td>{{ det.cantpersonas }}</td>
                <td>${{ det.subtotal }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3" class="total-label">Total:</td>
                <td class="total-value">${{ reserva.total }}</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Acciones -->
        <div class="actions">
          <!-- Si está CANCELADA: no mostrar NINGÚN botón -->
          <ng-container *ngIf="!esCancelada(reserva)">

            <!-- Si está PAGADA: mostrar SOLO el comprobante -->
            <ng-container *ngIf="esPagada(reserva); else accionesNormales">
              <button class="download-button" (click)="descargarComprobante(reserva)">
                Descargar Comprobante
              </button>
            </ng-container>

            <!-- Si NO está pagada (ni cancelada): botones normales -->
            <ng-template #accionesNormales>
              <button class="edit-button"
                      *ngIf="puedeEditar(reserva)"
                      (click)="editarReserva(reserva.idreserva)">
                <mat-icon>edit</mat-icon> Editar
              </button>

              <button class="cancel-button" (click)="cancelarReserva(reserva)">
                Cancelar
              </button>

              <button *ngIf="reserva.mostrarBotonPagoInicial"
                      class="pay-button" (click)="abrirPayPal('inicial', reserva)">
                Pago Inicial
              </button>

              <button *ngIf="reserva.mostrarBotonPagoFinal"
                      class="pay-button" (click)="abrirPayPal('final', reserva)">
                Pago Final
              </button>

              <button *ngIf="reserva.mostrarComprobante && !esPagada(reserva)"
                      class="download-button" (click)="descargarComprobante(reserva)">
                Descargar Comprobante
              </button>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </ng-container>
  </div>
</ng-container>

<ng-template #noData>
  <div class="no-data">No se encontraron reservas.</div>
</ng-template>

  <button mat-icon-button class="btn-back" (click)="volver()" matTooltip="Volver">
    <mat-icon>arrow_back</mat-icon>
  </button>
</div>
