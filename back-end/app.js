require('dotenv').config();
const express      = require('express');
const bodyParser   = require('body-parser');
const http         = require('http');
const socketIO     = require('socket.io');
const session      = require('express-session');
const cors         = require('cors');

const app = express();

// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
// 1) Middlewares de Express
// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// ‚Äî Nuevos: CORS y sesiones ‚Äî 
app.use(cors({
  origin: 'http://localhost:4200',    // tu front de Angular
  credentials: true,                  // habilita cookies
  methods: ['GET','POST','PUT','DELETE','OPTIONS']
}));

app.use(session({
  secret: process.env.SESSION_SECRET || 'cambia_esto_por_un_secreto_real',
  resave: false,
  saveUninitialized: false,
  cookie: {
    sameSite: 'lax',   // o 'none' si sirves en HTTPS y necesitas cross-site
    secure: false      // true si usas HTTPS
  }
}));

// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
// 1.1) Middleware de autenticaci√≥n
// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
function ensureAuth(req, res, next) {
  if (req.session && req.session.admin) {
    return next();
  }
  return res.status(401).send({ message: 'No autorizado' });
}

// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
// 2) Rutas REST de tu aplicaci√≥n
// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
require('./server/routes/usuarios')(app);
require('./server/routes/gestionclientes')(app);
require('./server/routes/cargoempleados')(app);

app.use('/api/gestionempleados', ensureAuth);
require('./server/routes/empleados')(app);


require('./server/routes/administrador')(app);

// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
// Protegemos proveedor
// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
app.use('/api/proveedor', ensureAuth);
require('./server/routes/proveedor')(app);

app.use('/api/productos', ensureAuth);
require('./server/routes/productos')(app);


require('./server/routes/tipocatering')(app);
require('./server/routes/serviciocatering')(app);
require('./server/routes/menus')(app);
require('./server/routes/estadocatering')(app);
require('./server/routes/recuperacion')(app);
require('./server/routes/preclientes')(app);
require('./server/routes/categoriaProductos')(app);
require('./server/routes/reservas')(app);
require('./server/routes/detalle_reserva')(app);
require('./server/routes/contacto')(app);
require('./server/routes/estado_reserva')(app);
require('./server/routes/notificaciones')(app);
require('./server/routes/reserva_producto')(app);


// Ruta catch‚Äêall
app.get('*', (req, res) => {
  res.status(200).send({ message: 'Bienvenido al servidor NodeJS' });
});

// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
// 3) Creamos el servidor HTTP aqu√≠, pero NO lo `listen`
//    Lo exportamos para que sea www.js quien ejecute `listen`.
// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
const server = http.createServer(app);
const io = new socketIO.Server(server, {
  cors: {
    origin: '*',
    methods: ['GET', 'POST']
  }
});

app.set('io', io);

// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
// 4) Manejo de conexiones Socket.IO
// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
io.on('connection', (socket) => {
  console.log(`üîå [Socket.IO] Cliente conectado: ${socket.id}`);

  socket.on('identificar-cliente', (codigocliente) => {
    const sala = `cliente_${codigocliente}`;
    socket.join(sala);
    console.log(`üëâ Socket ${socket.id} se uni√≥ a la sala: ${sala}`);
  });

  socket.on('identificar-admin', () => {
    socket.join('ADMIN');
    console.log(`üëâ Socket ${socket.id} se uni√≥ a la sala: ADMIN`);
  });

  socket.on('disconnect', () => {
    console.log(`‚ùå [Socket.IO] Cliente desconectado: ${socket.id}`);
  });
});

const { checkExpiracionesYNotificar } = require('./server/controllers/notificaciones');

// Al arrancar el servidor, lanzamos la primera comprobaci√≥n:
setImmediate(() => checkExpiracionesYNotificar(io));

// Luego, repetimos cada 24 horas:
setInterval(() => checkExpiracionesYNotificar(io), 24 * 60 * 60 * 1000);

// **Importante**: exportamos `app` y `server`.
// www.js se encargar√° de llamar a `server.listen(...)`.
module.exports = { app, server };
